name: Patch fNOS for UTM
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed tar kmod zstd qemu-user-static binfmt-support
          echo "âœ… ä¾èµ–åº“ä¸ QEMU æ¨¡æ‹Ÿå™¨å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"
          # æŠ“å–æœ€æ–°çš„ .img.xz æ–‡ä»¶å
          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
            -q '.assets[] | select(.name | endswith(".img.xz")) | .name' | \
            sed -E 's/.*_([0-9]+)\.img\.xz/\1 &/' | \
            sort -n | tail -n 1 | cut -d' ' -f2-)
          
          # æå–é£ç‰›ç‰ˆæœ¬å· (å¦‚ 489)
          VERSION_NUM=$(echo "$LATEST_ASSET" | grep -oP '(?<=_)\d+(?=\.img\.xz)')
          echo "VERSION=$VERSION_NUM" >> $GITHUB_ENV
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          
          echo "ğŸš€ æ­£åœ¨ä¸‹è½½é£ç‰›åŸºç¡€é•œåƒç‰ˆæœ¬: $VERSION_NUM"
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber

      - name: Decompress and Patch Image
        run: |
          echo "ğŸ“¦ æ­£åœ¨è§£å‹é•œåƒ..."
          unxz -v -c "${{ env.SOURCE_FILE }}" > source.img
          
          sudo losetup -D
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          
          echo "ğŸ’¾ æ­£åœ¨æå–å¹¶æŒ‚è½½ Rootfs..."
          mkdir -p mnt_new
          sudo dd if="${LOOP_DEV}p2" of=rootfs.img bs=1M status=none
          sudo mount rootfs.img mnt_new

          # 2. ç©ºé—´é‡Šæ”¾ (ä¸ºæ–°å†…æ ¸è…¾å‡ºç©ºé—´)
          sudo rm -rf mnt_new/lib/modules/6.12.41-trim

          # 3. å‡†å¤‡è·¨æ¶æ„ Chroot ç¯å¢ƒ
          echo "ğŸ”§ å‡†å¤‡ Chroot ç¯å¢ƒ..."
          sudo mkdir -p mnt_new/usr/bin mnt_new/dev mnt_new/proc mnt_new/sys
          sudo cp /usr/bin/qemu-aarch64-static mnt_new/usr/bin/
          
          sudo mount --bind /dev mnt_new/dev
          sudo mount --bind /proc mnt_new/proc
          sudo mount --bind /sys mnt_new/sys
          sudo cp /etc/resolv.conf mnt_new/etc/resolv.conf

          # 4. æ‰§è¡Œ Chroot å®‰è£…æ ‡å‡†å†…æ ¸å¹¶æ•è·ç‰ˆæœ¬å·
          echo "ğŸŒ æ­£åœ¨åœ¨çº¿å®‰è£… Debian æ ‡å‡†å†…æ ¸..."
          sudo chroot mnt_new /bin/bash -c "
            apt-get update
            apt-get install -y --allow-change-held-packages linux-image-arm64
            apt-get clean
          "
          
          # ã€è‡ªåŠ¨æå–å†…æ ¸ç‰ˆæœ¬å·ã€‘ä¾‹å¦‚ 6.1.0-31-arm64
          K_VER=$(ls mnt_new/boot/vmlinuz-*-arm64 | head -n 1 | sed 's/.*vmlinuz-//')
          echo "KERNEL_VERSION=$K_VER" >> $GITHUB_ENV
          echo "âœ… æˆåŠŸæå– Debian å†…æ ¸ç‰ˆæœ¬: $K_VER"

          # 5. æå–äº§ç‰©
          cp $(ls mnt_new/boot/vmlinuz-*-arm64 | head -n 1) ./vmlinuz-standard
          cp $(ls mnt_new/boot/initrd.img-*-arm64 | head -n 1) ./initrd-standard

          # 6. åº”ç”¨è™šæ‹Ÿæœºé€‚é…ä¿®æ­£
          echo "ğŸ› ï¸ æ­£åœ¨ä¿®æ­£ fstab æŒ‚è½½ç‚¹..."
          echo ">>> [ä¿®æ”¹å‰] fstab å†…å®¹:"
          cat mnt_new/etc/fstab
          
          # æ³¨é‡Š boot åˆ†åŒº
          sudo sed -i 's/^.*\/boot/#&/' mnt_new/etc/fstab
          
          # ç²¾å‡†æ›¿æ¢æ ¹ç›®å½•ï¼šåŒæ—¶å…¼å®¹ UUID= æ¨¡å¼å’Œæ—§ç‰ˆ /dev/mmcblk æ¨¡å¼
          # ä½¿ç”¨ [[:space:]] ç¡®ä¿å®Œç¾åˆ‡åˆ† Tab æˆ–ç©ºæ ¼
          sudo sed -i 's|^.*/boot|#&|' mnt_new/etc/fstab
          sudo sed -i 's|^\(UUID=[^[:space:]]*\|/dev/mmcblk[^[:space:]]*\)|/dev/vda|' mnt_new/etc/fstab
          
          echo ">>> [ä¿®æ”¹å] fstab å†…å®¹:"
          cat mnt_new/etc/fstab
          
          # ç§»é™¤å†²çªçš„ç¡¬ä»¶ç›¸å…³æœåŠ¡
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_miniscreen.service
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_wayland.service

          # 7. å½»åº•æ¸…ç†å¸è½½
          echo "ğŸ§¹ æ¸…ç†å¸è½½ä¸­..."
          sudo rm -f mnt_new/usr/bin/qemu-aarch64-static
          sudo umount mnt_new/dev mnt_new/proc mnt_new/sys
          sudo umount mnt_new
          sudo losetup -d $LOOP_DEV
          rm source.img
          echo "âœ… è¡¥ä¸å¤„ç†æµç¨‹ç»“æŸ"

      - name: Final Packaging
        run: |
          PKG_DIR="fn_utm_${{ env.VERSION }}"
          mkdir -p "$PKG_DIR"
          mv rootfs.img vmlinuz-standard initrd-standard "$PKG_DIR/"
          
          # ç”Ÿæˆ README æ—¶åŠ å…¥å†…æ ¸ç‰ˆæœ¬å·
          cat << EOF > "$PKG_DIR/README.md"
          # fNOS UTM ARM64 (Standard Kernel)
          
          - é£ç‰›é•œåƒç‰ˆæœ¬: ${{ env.VERSION }}
          - æ›¿æ¢å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}
          - ä¿®æ”¹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          
          ### å¼•å¯¼é…ç½®æŒ‡å—
          1. ç£ç›˜ (Drive): rootfs.img (æ¥å£è¯·é€‰æ‹© VirtIO)
          2. å†…æ ¸ (Kernel): vmlinuz-standard
          3. åˆå§‹åŒ–ç›˜ (Initrd): initrd-standard
          4. å¯åŠ¨å‚æ•° (Arguments): "root=/dev/vda rw console=tty0 console=ttyAMA0 rootwait"
          
          *è¯´æ˜ï¼šæ­¤ç‰ˆæœ¬å·²ä¿®æ­£ fstabï¼Œå°†æ ¹ç›®å½•æŒ‚è½½ç‚¹é€‚é…ä¸º /dev/vdaï¼Œæ”¯æŒæ ‡å‡† Debian å†…æ ¸å¯åŠ¨ã€‚*
          EOF

          tar -cvf - "$PKG_DIR" | xz -z -T0 -v > "${PKG_DIR}.tar.xz"
          echo "FINAL_PKG_NAME=${PKG_DIR}.tar.xz" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          name: fnnas_utm_${{ env.VERSION }}
          body: |
            fnOS UTM è™šæ‹Ÿæœº (é›†æˆæ ‡å‡†å†…æ ¸)
            - é£ç‰›ç‰ˆæœ¬: ${{ env.VERSION }}
            - Debian å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}
          files: ${{ env.FINAL_PKG_NAME }}
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
