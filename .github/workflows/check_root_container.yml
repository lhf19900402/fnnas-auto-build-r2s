name: Detect Init Type in Firmware

on:
  workflow_dispatch: # 手动触发

jobs:
  detect-init:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download firmware release
        run: |
          # 自动获取最新 release asset
          ASSET_URL=$(gh release view fnnas_v338 --json assets -q '.assets[].browser_download_url | select(contains(".img.gz"))')
          echo "Downloading firmware from $ASSET_URL ..."
          curl -L -o firmware.img.gz "$ASSET_URL"

      - name: Uncompress firmware
        run: gzip -d firmware.img.gz

      - name: Extract rootfs using binwalk
        run: |
          mkdir rootfs_extract
          binwalk -e firmware.img -C rootfs_extract

      - name: Detect init type
        id: detect
        run: |
          ROOTFS=$(find rootfs_extract -type d -name "*squashfs-root*" | head -n1)
          INIT_TYPE=""
          if [ -d "$ROOTFS/etc/init.d" ] || [ -f "$ROOTFS/etc/rc.local" ]; then
            INIT_TYPE="initd"
          elif [ -d "$ROOTFS/usr/lib/systemd" ] || [ -d "$ROOTFS/lib/systemd" ]; then
            INIT_TYPE="systemd"
          else
            INIT_TYPE="unknown"
          fi
          echo "Detected init type: $INIT_TYPE"
          echo "init_type=$INIT_TYPE" >> $GITHUB_OUTPUT

      - name: Show result
        run: |
          echo "Init type detected: ${{ steps.detect.outputs.init_type }}"
