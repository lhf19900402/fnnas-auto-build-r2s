name: Detect Init Type in Firmware

on:
  workflow_dispatch:

jobs:
  detect-init:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y binwalk gzip

      - name: Download firmware release via API
        run: |
          echo "Fetching firmware release URL ..."
          ASSET_URL=$(curl -s https://api.github.com/repos/lhf19900402/fnnas-auto-build-r2s/releases/tags/fnnas_v338 \
            | grep browser_download_url \
            | grep ".img.gz" \
            | head -n1 \
            | cut -d '"' -f 4)
          echo "Downloading firmware from $ASSET_URL ..."
          curl -L -o firmware.img.gz "$ASSET_URL"

      - name: Uncompress firmware
        run: gzip -d firmware.img.gz

      - name: Extract rootfs using binwalk
        run: |
          mkdir rootfs_extract
          binwalk -e firmware.img -C rootfs_extract

      - name: Detect init type
        id: detect
        run: |
          ROOTFS=$(find rootfs_extract -type d -name "*squashfs-root*" | head -n1)
          INIT_TYPE=""
          if [ -d "$ROOTFS/etc/init.d" ] || [ -f "$ROOTFS/etc/rc.local" ]; then
            INIT_TYPE="initd"
          elif [ -d "$ROOTFS/usr/lib/systemd" ] || [ -d "$ROOTFS/lib/systemd" ]; then
            INIT_TYPE="systemd"
          else
            INIT_TYPE="unknown"
          fi
          echo "Detected init type: $INIT_TYPE"
          echo "init_type=$INIT_TYPE" >> $GITHUB_OUTPUT

      - name: Show result
        run: |
          echo "Init type detected: ${{ steps.detect.outputs.init_type }}"
