name: Build FNNAS rk3328-nanopi-r2s

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-utils parted gh

    - name: è·å–æœ€æ–° ophub/fnnas release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # è·å–æœ€æ–° release tagï¼ˆä»…tagååŒ…å«rockchipï¼‰
        LATEST_TAG=$(gh release list --repo ophub/fnnas --json tagName -q '.[] | select(.tagName | contains("rockchip")) | .tagName' | head -n 1)
        echo "æœ€æ–° release tag: $LATEST_TAG"
        echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

    - name: ä¸‹è½½æœ€æ–°å›ºä»¶
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh release download "$LATEST_TAG" \
          --repo ophub/fnnas \
          --pattern '*renegade-rk3328*.img.gz'
        IMG_GZ=$(ls *renegade-rk3328*.img.gz)
        echo "ä¸‹è½½å®Œæˆ: $IMG_GZ"
        echo "IMG_GZ=$IMG_GZ" >> $GITHUB_ENV
        echo "IMG=${IMG_GZ%.gz}" >> $GITHUB_ENV

    - name: è§£å‹å›ºä»¶
      run: gzip -d "${{ env.IMG_GZ }}"

    - name: æ³¨å…¥è‡ªå®šä¹‰ DTB å¹¶ä¿®æ”¹ armbianEnv.txt
      run: |
        IMG="${{ env.IMG }}"
        DTB_SOURCE="dtb/rk3328-nanopi-r2s.dtb"
        
        # 1. æ£€æŸ¥ä»“åº“ä¸­æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$DTB_SOURCE" ]; then
          echo "âŒ é”™è¯¯: ä»“åº“ä¸­æ‰¾ä¸åˆ°æºæ–‡ä»¶ $DTB_SOURCE"
          exit 1
        fi

        # 2. æŒ‚è½½é•œåƒ
        LOOP=$(sudo losetup -fP "$IMG" --show)
        mkdir -p mnt
        sudo mount "${LOOP}p1" mnt
        echo "âœ… é•œåƒåˆ†åŒº p1 å·²æŒ‚è½½"

        # 3. ä¸¥æ ¼æ£€æŸ¥é•œåƒå†…çš„ç›®å½•ç»“æ„
        TARGET_DIR="mnt/dtb/rockchip"
        if [ ! -d "$TARGET_DIR" ]; then
          echo "âŒ è‡´å‘½é”™è¯¯: é•œåƒå†…éƒ¨è·¯å¾„ /dtb/rockchip ä¸å­˜åœ¨ï¼"
          echo "åŸå› : å›ºä»¶ç»“æ„ä¸é¢„æœŸä¸ç¬¦ï¼Œä¸ºäº†é˜²æ­¢æ³¨å…¥å¤±æ•ˆï¼ŒWorkflow å°†ç›´æ¥é€€å‡ºã€‚"
          sudo umount mnt
          sudo losetup -d "$LOOP"
          exit 1
        else
          echo "âœ… ç¡®è®¤é•œåƒå†…éƒ¨è·¯å¾„ $TARGET_DIR å·²å­˜åœ¨"
        fi

        # 4. æ‹·è´æ–‡ä»¶å¹¶æ ¡éªŒ
        echo "æ­£åœ¨æ³¨å…¥è‡ªå®šä¹‰ DTB..."
        sudo cp -f "$DTB_SOURCE" "$TARGET_DIR/rk3328-nanopi-r2s.dtb"
        if [ $? -eq 0 ]; then
          echo "âœ… DTB æ–‡ä»¶æ³¨å…¥æˆåŠŸ: $TARGET_DIR/rk3328-nanopi-r2s.dtb"
          # æ‰“å° MD5 æ ¡éªŒï¼Œç¡®ä¿æ‹·è´çš„æ–‡ä»¶å®Œæ•´æ— è¯¯
          md5sum "$DTB_SOURCE"
          md5sum "$TARGET_DIR/rk3328-nanopi-r2s.dtb"
        else
          echo "âŒ é”™è¯¯: DTB æ–‡ä»¶æ‹·è´å¤±è´¥"
          sudo umount mnt
          sudo losetup -d "$LOOP"
          exit 1
        fi

        # 5. ä¿®æ”¹ armbianEnv.txt
        echo "æ­£åœ¨ä¿®æ”¹ armbianEnv.txt..."
        if [ -f "mnt/armbianEnv.txt" ]; then
          sudo sed -i -E 's|^fdtfile=.*$|fdtfile=rockchip/rk3328-nanopi-r2s.dtb|' mnt/armbianEnv.txt
          echo "âœ… armbianEnv.txt ä¿®æ”¹åçš„å†…å®¹å¦‚ä¸‹:"
          cat mnt/armbianEnv.txt
        else
          echo "âŒ é”™è¯¯: åœ¨é•œåƒåˆ†åŒºä¸­æ‰¾ä¸åˆ° armbianEnv.txt"
          sudo umount mnt
          sudo losetup -d "$LOOP"
          exit 1
        fi

        # 6. å¸è½½æ¸…ç†
        sudo umount mnt
        sudo losetup -d "$LOOP"
        echo "ğŸš€ ä¿®æ”¹æµç¨‹åœ†æ»¡å®Œæˆï¼Œé•œåƒå·²å®‰å…¨å¸è½½"

    - name: å‹ç¼©å¹¶é‡å‘½åå›ºä»¶
      run: |
        IMG="${{ env.IMG }}"
        gzip "$IMG"
        NEW_NAME=$(echo "$IMG.gz" | sed 's/rockchip_renegade-rk3328/rk3328-nanopi-r2s/')
        mv "$IMG.gz" "$NEW_NAME"
        echo "æœ€ç»ˆå›ºä»¶: $NEW_NAME"
        echo "NEW_NAME=$NEW_NAME" >> $GITHUB_ENV

    - name: æ£€æŸ¥ release æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        if gh release view "$LATEST_TAG" >/dev/null 2>&1; then
          echo "Release $LATEST_TAG å·²å­˜åœ¨ï¼Œå°†è¦†ç›–ä¸Šä¼ æ–‡ä»¶ã€‚"
        else
          echo "Release $LATEST_TAG ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ releaseã€‚"
          gh release create "$LATEST_TAG" --title "$LATEST_TAG" --notes "è‡ªåŠ¨æ„å»ºå›ºä»¶" || true
        fi

    - name: ä¸Šä¼ å›ºä»¶ï¼ˆè¦†ç›–ç°æœ‰ release æ–‡ä»¶ï¼‰
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.LATEST_TAG }}   # release tag ä¸ ophub/fnnas åŒæ­¥
        name: ${{ env.LATEST_TAG }}       # release title ä¸ ophub/fnnas åŒæ­¥
        files: ${{ env.NEW_NAME }}        # ä¸Šä¼ ä¿®æ”¹åçš„å›ºä»¶æ–‡ä»¶
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
