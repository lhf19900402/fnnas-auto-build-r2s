name: Build FNNAS Firmware

on:
  workflow_dispatch:

# ğŸ”‘ å…³é”®ï¼šå…è®¸åˆ›å»º release / tag / ä¸Šä¼ èµ„äº§
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-utils parted gh

    - name: è·å–æœ€æ–° Release å¹¶ä¸‹è½½ renegade-rk3328 é•œåƒ
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        LATEST_TAG=$(gh release list \
          --repo ophub/fnnas \
          --limit 1 \
          --json tagName \
          -q '.[0].tagName')

        echo "æœ€æ–° release tag: $LATEST_TAG"

        gh release download "$LATEST_TAG" \
          --repo ophub/fnnas \
          --pattern '*renegade-rk3328*.img.gz'

    - name: è§£å‹é•œåƒ
      run: gzip -d *.img.gz

    - name: æŒ‚è½½é•œåƒå¹¶ä¿®æ”¹ armbianEnv.txt
      run: |
        IMG=$(ls *.img)
        LOOP=$(sudo losetup -fP "$IMG" --show)

        mkdir mnt
        sudo mount "${LOOP}p1" mnt

        sudo sed -i -E \
          's|^fdtfile=.*$|fdtfile=rockchip/rk3328-nanopi-r2s.dtb|' \
          mnt/armbianEnv.txt

        sudo umount mnt
        sudo losetup -d "$LOOP"

    - name: é‡æ–°å‹ç¼©é•œåƒ
      run: gzip *.img

    - name: åˆ›å»ºæ–°çš„ Release å¹¶ä¸Šä¼ å›ºä»¶
      uses: softprops/action-gh-release@v1
      with:
        tag_name: rebuilt-${{ github.run_id }}
        name: rebuilt-renegade-rk3328
        files: '*.img.gz'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
