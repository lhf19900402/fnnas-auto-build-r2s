name: Build FNNAS Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-utils parted gh

    - name: 获取最新 Release 并下载 renegade-rk3328 镜像
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # 获取最新 release tag
        LATEST_TAG=$(gh release list \
          --repo ophub/fnnas \
          --limit 1 \
          --json tagName \
          -q '.[0].tagName')

        echo "最新 release tag: $LATEST_TAG"

        # 下载最新 release 中包含 renegade-rk3328 的镜像
        gh release download "$LATEST_TAG" \
          --repo ophub/fnnas \
          --pattern '*renegade-rk3328*.img.gz'

        ls -lh

    - name: 解压镜像
      run: |
        gzip -d *.img.gz
        ls -lh

    - name: 挂载镜像并修改 armbianEnv.txt
      run: |
        IMG=$(ls *.img)
        echo "镜像文件: $IMG"

        LOOP=$(sudo losetup -fP "$IMG" --show)
        echo "使用 loop 设备: $LOOP"

        mkdir mnt
        sudo mount "${LOOP}p1" mnt

        echo "原始 fdtfile:"
        sudo grep '^fdtfile=' mnt/armbianEnv.txt || true

        sudo cp mnt/armbianEnv.txt mnt/armbianEnv.txt.bak

        sudo sed -i -E \
          's|^fdtfile=.*$|fdtfile=rockchip/rk3328-nanopi-r2s.dtb|' \
          mnt/armbianEnv.txt

        echo "修改后的 fdtfile:"
        sudo grep '^fdtfile=' mnt/armbianEnv.txt || true

        sudo umount mnt
        sudo losetup -d "$LOOP"

    - name: 重新压缩镜像
      run: |
        gzip *.img
        ls -lh

    - name: 创建新的 Release 并上传固件
      uses: softprops/action-gh-release@v1
      with:
        tag_name: rebuilt-${{ github.run_id }}
        name: rebuilt-renegade-rk3328
        files: '*.img.gz'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
