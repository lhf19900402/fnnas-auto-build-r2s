name: Build FNNAS Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-utils parted gh

    - name: 获取最新 Release 并下载 renagade-rk3328 镜像
      run: |
        # 获取最新 release tag
        LATEST_TAG=$(gh release list --repo ophub/fnnas --limit 1 --json tagName -q '.[0].tagName')
        echo "最新 release: $LATEST_TAG"

        # 下载最新 release 中匹配 renegade-rk3328 的 asset
        gh release download $LATEST_TAG --repo ophub/fnnas --pattern '*renegade-rk3328*.img.gz'

    - name: 解压镜像
      run: gzip -d *.img.gz

    - name: 挂载镜像并修改 armbianEnv.txt
      run: |
        IMG=$(ls *.img)
        echo "镜像文件: $IMG"

        # 创建 loop 设备并挂载 boot 分区
        LOOP=$(sudo losetup -fP $IMG --show)
        echo "使用 loop 设备: $LOOP"

        mkdir mnt
        sudo mount ${LOOP}p1 mnt

        # 备份原始 armbianEnv.txt
        sudo cp mnt/armbianEnv.txt mnt/armbianEnv.txt.bak

        # 替换 fdtfile
        sudo sed -i -E 's|^fdtfile=.*$|fdtfile=rockchip/rk3328-nanopi-r2s.dtb|' mnt/armbianEnv.txt

        # 显示修改结果
        echo "修改后的内容:"
        sudo grep '^fdtfile=' mnt/armbianEnv.txt || true

        # 卸载 & 清理
        sudo umount mnt
        sudo losetup -d $LOOP

    - name: 重新压缩镜像
      run: gzip -k *.img

    - name: 创建新的 Release 并上传固件
      uses: softprops/action-gh-release@v1
      with:
        tag_name: rebuilt-${{ github.run_id }}
        name: rebuilt-firmware-${{ github.run_id }}.img.gz
        files: '*.img.gz'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
