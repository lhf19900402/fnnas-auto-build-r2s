name: Patch fNOS Image for UTM
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # èµ‹äºˆ Release å†™å…¥æƒé™

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed tar kmod zstd
          echo "RAW_KERNEL=vmlinuz-6.12.41-trim" >> $GITHUB_ENV
          echo "RAW_INITRD=initrd.img-6.12.41-trim" >> $GITHUB_ENV
          echo "âœ… ä¾èµ–åº“ä¸ zstd å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"
          
          echo "ğŸ” æ­£åœ¨æœç´¢æœ€æ–°é™„ä»¶..."
          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
            -q '.assets[] | select(.name | endswith(".img.xz")) | .name' | \
            sed -E 's/.*_([0-9]+)\.img\.xz/\1 &/' | \
            sort -n | \
            tail -n 1 | \
            cut -d' ' -f2-)
          
          if [ -z "$LATEST_ASSET" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° .img.xz é™„ä»¶"
            exit 1
          fi
          
          echo "ğŸ¯ é”å®šæœ€æ–°é•œåƒ: $LATEST_ASSET"
          VERSION=$(echo "$LATEST_ASSET" | grep -oP '(?<=_)\d+(?=\.img\.xz)' || echo "unknown")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½: $LATEST_ASSET"
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber

      - name: Decompress and Patch Image
        run: |
          echo "ğŸ“¦ æ­£åœ¨è§£å‹æ–°é•œåƒ..."
          unxz -v -c "${{ env.SOURCE_FILE }}" > source.img
          
          sudo losetup -D
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          mkdir -p mnt_new

          echo "ğŸ’¾ æ­£åœ¨æå–å¹¶æŒ‚è½½ Rootfs..."
          sudo dd if="${LOOP_DEV}p2" of=rootfs.img bs=1M status=none
          sudo mount rootfs.img mnt_new

          # -------------------------------------------------------
          # 2. æ ¸å¿ƒæ³¨å…¥é€»è¾‘ï¼šå®šç‚¹æå– Zstd æ¨¡å—
          # -------------------------------------------------------
          echo "ğŸ’‰ æ­£åœ¨æå– Zstd æ ¼å¼çš„ initrd æ¨¡å—..."
          mkdir -p ./extracted_initrd
          
          # ç›´æ¥ä½¿ç”¨ zstdcatï¼Œå¹¶å¢åŠ  --quiet å±è”½æ— å…³è­¦å‘Š
          # ç¡®ä¿ RAW_INITRD å˜é‡æŒ‡å‘ ./old_modules/ ç›®å½•ä¸‹çš„æ–‡ä»¶
          zstdcat ./old_modules/${{ env.RAW_INITRD }} | (cd ./extracted_initrd && sudo cpio -idm --quiet 2>/dev/null)

          # åŠ¨æ€å®šä½ 6.12.41-trim ç›®å½•çš„å®é™…ä½ç½®
          MOD_PATH=$(find ./extracted_initrd -name "6.12.41-trim" -type d | head -n 1)

          if [ -z "$MOD_PATH" ]; then
              echo "âŒ é”™è¯¯ï¼šè§£å‹æˆåŠŸä½†æœªæ‰¾åˆ° 6.12.41-trim æ–‡ä»¶å¤¹"
              exit 1
          fi

          echo "ğŸ¯ æå–æˆåŠŸï¼Œå‡†å¤‡æ³¨å…¥ rootfs..."
          sudo rm -rf mnt_new/lib/modules/6.12.41-trim
          sudo cp -a "$MOD_PATH" mnt_new/lib/modules/
          
          # åˆ·æ–°ä¾èµ–
          sudo depmod -a -b mnt_new 6.12.41-trim
          sudo rm -rf ./extracted_initrd
          # -------------------------------------------------------

          echo "ğŸ› ï¸ æ­£åœ¨åº”ç”¨è™šæ‹Ÿæœºé€‚é…ä¿®æ­£..."
          sudo sed -i 's/^.*\/boot/#&/' mnt_new/etc/fstab
          # å¼ºè¡Œå°†æ‰€æœ‰æŒ‚è½½ç‚¹ä¿®æ­£ä¸º vdaï¼Œè§£å†³ UUID å¯¼è‡´çš„ç»´æŠ¤æ¨¡å¼é—®é¢˜
          sudo sed -i 's/^UUID=[^ ]*/\/dev\/vda/' mnt_new/etc/fstab
          sudo sed -i 's/^\/dev\/mmcblk0p2/\/dev\/vda/' mnt_new/etc/fstab
          
          # ç§»é™¤å†²çªæœåŠ¡
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_miniscreen.service
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_wayland.service

          sync
          sudo umount mnt_new
          sudo losetup -d $LOOP_DEV
          rm source.img
          echo "âœ… é©±åŠ¨æ³¨å…¥ä¸é€‚é…å®Œæˆ"

      - name: Create README for UTM
        run: |
          cat << EOF > README.md
          # fNOS UTM è™šæ‹Ÿæœºçº¯å‡€ç‰ˆ (åŸºäºè€å†…æ ¸é©±åŠ¨æ³¨å…¥)

          ## ğŸš€ å…³é”®é…ç½®
          1. **é©±åŠ¨å™¨**: å¯¼å…¥ \`rootfs.img\` (æ¥å£: VirtIO)ã€‚
          2. **å¤–éƒ¨å†…æ ¸**: ä½¿ç”¨ä»“åº“ä¸­çš„ \`vmlinuz-6.12.41-trim\`ã€‚
          3. **Initrd**: ä½¿ç”¨ä»“åº“ä¸­çš„ \`initrd.img-6.12.41-trim\`ã€‚
          4. **Arguments**: 
             \`root=/dev/vda rw console=tty0 console=ttyAMA0 rootwait\`
          EOF

      - name: Final Packaging (Tar + XZ)
        run: |
          PKG_DIR="fn_utm_${{ env.VERSION }}"
          mkdir -p "$PKG_DIR"
          
          # ç§»åŠ¨æ‰‹æœ¯åçš„ç£ç›˜é•œåƒ
          mv rootfs.img "$PKG_DIR/"
          
          # ä» old_modules æ–‡ä»¶å¤¹ä¸­æ‹·è´å¯åŠ¨æ–‡ä»¶
          cp "./old_modules/${{ env.RAW_KERNEL }}" "$PKG_DIR/"
          cp "./old_modules/${{ env.RAW_INITRD }}" "$PKG_DIR/"
          
          mv README.md "$PKG_DIR/"
          
          echo "ğŸ—œï¸ æ­£åœ¨æ‰“åŒ…å‹ç¼©..."
          tar -cvf - "$PKG_DIR" | xz -z -T0 -v > "${PKG_DIR}.tar.xz"
          echo "FINAL_PKG_NAME=${PKG_DIR}.tar.xz" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          name: fnnas_utm_${{ env.VERSION }}
          body: |
            fnOS UTM è™šæ‹Ÿæœº ARM ç‰ˆ 
          files: ${{ env.FINAL_PKG_NAME }}
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
