name: å†…æ ¸å·¥å‚
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…å®¿ä¸»æœºå·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support curl debootstrap
          echo "âœ… å®¿ä¸»æœºå·¥å…·å‡†å¤‡å°±ç»ª"

      - name: ç‰ˆæœ¬å“¨å…µ (æ£€æŸ¥ä»“åº“ä¸ Release)
        id: sentinel
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è·å– Debian å®˜æ–¹ä»“åº“æœ€æ–°çš„æ ‡å‡†ç‰ˆå†…æ ¸å…¨å
          INDEX_URL="http://ftp.debian.org/debian/dists/bookworm/main/binary-arm64/Packages.gz"
          FULL_PACKAGE=$(curl -s "$INDEX_URL" | zgrep "Package: linux-image-6.1.0-" | awk '{print $2}' | grep -vE "rt|dbg|unsigned|cloud" | sort -V | tail -n 1)
          
          # 2. æå–ç²¾ç¡®çš„ç‰ˆæœ¬å·åç¼€
          K_SUFFIX=$(echo $FULL_PACKAGE | grep -oP '(?<=6\.1\.0-)\d+(?=-arm64)')
          KVER_FULL="6.1.0-$K_SUFFIX"
          echo "KVER_FULL=$KVER_FULL" >> $GITHUB_ENV
          
          # 3. æ£€æŸ¥ GitHub Release (æ ‡ç­¾ä¸º kernel-assets) æ˜¯å¦å·²æœ‰æ­¤æ–‡ä»¶
          RELEASE_TAG="kernel-assets"
          EXISTS=$(gh release view "$RELEASE_TAG" --json assets -q ".assets[] | select(.name == \"initrd.img-$KVER_FULL-arm64\") | .name" 2>/dev/null || echo "")

          if [ -n "$EXISTS" ]; then
            echo "ğŸ ç‰ˆæœ¬ $KVER_FULL å·²å­˜åœ¨ã€‚å·²ç»æ˜¯æœ€æ–°ï¼Œè·³è¿‡æ„å»ºã€‚"
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
          else
            echo "ğŸš€ å‘ç°æ–°ç‰ˆæœ¬ $KVER_FULLï¼Œå‡†å¤‡å¼€å§‹å·¥å‚æ„å»º..."
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: æ„å»º ARM64 ç¯å¢ƒ
        if: env.SKIP_BUILD == 'false'
        run: |
          echo "ğŸ—ï¸ æ­£åœ¨é€šè¿‡ debootstrap æ„å»º ARM64 æœ€å°åŒ–ç³»ç»Ÿ..."
          echo "âš ï¸ æ­¤æ­¥éª¤æ¶‰åŠ QEMU æ¨¡æ‹Ÿè§£å‹ï¼Œçº¦è€—æ—¶ 5-10 åˆ†é’Ÿï¼Œè¯·å‹¿å…³é—­ã€‚"
          
          sudo debootstrap --arch=arm64 --variant=minbase --merged-usr bookworm chroot http://ftp.debian.org/debian/
          
          sudo cp /usr/bin/qemu-aarch64-static chroot/usr/bin/
          sudo mount --bind /dev chroot/dev
          sudo mount --bind /proc chroot/proc
          sudo mount --bind /sys chroot/sys
          echo "âœ… ç¯å¢ƒæ„å»ºå®Œæˆ"

      - name: ç”Ÿæˆå†…æ ¸ä¸ Initrd (zstd å‹ç¼©)
        if: env.SKIP_BUILD == 'false'
        run: |
          echo "â³ æ­£åœ¨ Chroot ç¯å¢ƒå†…å®‰è£…å†…æ ¸å¹¶æ‰§è¡Œ zstd å‹ç¼©..."
          sudo chroot chroot /bin/bash -c "
            apt-get update
            apt-get install -y initramfs-tools kmod zstd --no-install-recommends
            
            # å®‰è£…æ¢æµ‹åˆ°çš„æœ€æ–°ç‰ˆæœ¬å†…æ ¸
            apt-get install -y linux-image-${{ env.KVER_FULL }}-arm64
            
            # å¼ºåˆ¶è®¾å®šä¸º zstd å‹ç¼©æ¨¡å¼
            sed -i 's/COMPRESS=.*/COMPRESS=zstd/g' /etc/initramfs-tools/initramfs.conf
            
            # ç”Ÿæˆå¼•å¯¼é•œåƒ
            update-initramfs -c -k ${{ env.KVER_FULL }}-arm64
          "
          
          cp chroot/boot/vmlinuz-${{ env.KVER_FULL }}-arm64 ./vmlinuz-${{ env.KVER_FULL }}-arm64
          cp chroot/boot/initrd.img-${{ env.KVER_FULL }}-arm64 ./initrd.img-${{ env.KVER_FULL }}-arm64
          
          sudo umount -l chroot/dev chroot/proc chroot/sys
          echo "âœ… å¼•å¯¼æ–‡ä»¶ç”ŸæˆæˆåŠŸ"

      - name: ä¸Šä¼ æ–‡ä»¶è‡³ Release
        if: env.SKIP_BUILD == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: kernel-assets
          name: "Debian å†…æ ¸ç»„ä»¶å·¥å‚"
          files: |
            vmlinuz-${{ env.KVER_FULL }}-arm64
            initrd.img-${{ env.KVER_FULL }}-arm64
          body: "æ­¤ Release ç”¨äºå­˜æ”¾è‡ªåŠ¨ç”Ÿæˆçš„æ ‡å‡†å†…æ ¸æ–‡ä»¶ã€‚æ„å»ºç‰ˆæœ¬: ${{ env.KVER_FULL }}"
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä»»åŠ¡æ€»ç»“
        run: |
          echo "### æ„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.SKIP_BUILD }}" == "true" ]; then
            echo "çŠ¶æ€: âœ… è·³è¿‡ (å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬)" >> $GITHUB_STEP_SUMMARY
          else
            echo "çŠ¶æ€: ğŸ‰ æˆåŠŸ (å·²åˆ›å»ºç‰ˆæœ¬ ${{ env.KVER_FULL }})" >> $GITHUB_STEP_SUMMARY
          fi
