name: å†…æ ¸å·¥å‚
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: ç¯å¢ƒå‡†å¤‡
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support curl debootstrap
          echo "âœ… å®¿ä¸»æœºå·¥å…·å°±ç»ª"

      - name: ç‰ˆæœ¬çŠ¶æ€æ£€æŸ¥
        id: sentinel
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          INDEX_URL="http://ftp.debian.org/debian/dists/bookworm/main/binary-arm64/Packages.gz"
          FULL_PACKAGE=$(curl -s "$INDEX_URL" | zgrep "Package: linux-image-6.1.0-" | awk '{print $2}' | grep -vE "rt|dbg|unsigned|cloud" | sort -V | tail -n 1)
          K_SUFFIX=$(echo $FULL_PACKAGE | grep -oP '(?<=6\.1\.0-)\d+(?=-arm64)')
          KVER_FULL="6.1.0-$K_SUFFIX"
          echo "KVER_FULL=$KVER_FULL" >> $GITHUB_ENV
          
          RELEASE_TAG="kernel-assets"
          EXISTS=$(gh release view "$RELEASE_TAG" --json assets -q ".assets[] | select(.name == \"initrd.img-$KVER_FULL-arm64\") | .name" 2>/dev/null || echo "")

          if [ -n "$EXISTS" ]; then
            echo "ğŸ ç‰ˆæœ¬ $KVER_FULL å·²å­˜åœ¨ã€‚è·³è¿‡æ„å»ºã€‚"
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
          else
            echo "ğŸš€ å‘ç°æ–°ç‰ˆæœ¬ $KVER_FULLï¼Œå¼€å§‹æ„å»º..."
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: æ„å»º ARM64 ç¯å¢ƒ
        if: env.SKIP_BUILD == 'false'
        run: |
          echo "ğŸ—ï¸ æ­£åœ¨æ„å»ºæœ€å°åŒ–ç³»ç»Ÿ (çº¦ 5 åˆ†é’Ÿ)..."
          sudo debootstrap --arch=arm64 --variant=minbase --merged-usr bookworm chroot http://ftp.debian.org/debian/
          
          sudo cp /usr/bin/qemu-aarch64-static chroot/usr/bin/
          sudo mount --bind /dev chroot/dev
          sudo mount --bind /proc chroot/proc
          sudo mount --bind /sys chroot/sys

      - name: ç”Ÿäº§å†…æ ¸ç»„ä»¶ (zstd)
        if: env.SKIP_BUILD == 'false'
        run: |
          echo "â³ æ­£åœ¨å®‰è£…å†…æ ¸å¹¶ç”Ÿæˆé•œåƒ (zstd æ¨¡æ‹Ÿå‹ç¼©ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…)..."
          sudo chroot chroot /bin/bash -c "
            apt-get update
            apt-get install -y initramfs-tools kmod zstd --no-install-recommends
            # é¢„è®¾ zstd æ ¼å¼ï¼Œè®©æ¥ä¸‹æ¥çš„ apt å®‰è£…åªè§¦å‘ä¸€æ¬¡ç”Ÿæˆ
            sed -i 's/COMPRESS=.*/COMPRESS=zstd/g' /etc/initramfs-tools/initramfs.conf
            apt-get install -y linux-image-${{ env.KVER_FULL }}-arm64
          "
          cp chroot/boot/vmlinuz-${{ env.KVER_FULL }}-arm64 ./vmlinuz-${{ env.KVER_FULL }}-arm64
          cp chroot/boot/initrd.img-${{ env.KVER_FULL }}-arm64 ./initrd.img-${{ env.KVER_FULL }}-arm64
          sudo umount -l chroot/dev chroot/proc chroot/sys
          echo "âœ… ç»„ä»¶ç”ŸæˆæˆåŠŸ"

      - name: å‘å¸ƒè‡³ Release
        if: env.SKIP_BUILD == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: kernel-assets
          name: "Debian å†…æ ¸ç»„ä»¶å·¥å‚"
          files: |
            vmlinuz-${{ env.KVER_FULL }}-arm64
            initrd.img-${{ env.KVER_FULL }}-arm64
          body: "æ„å»ºç‰ˆæœ¬: ${{ env.KVER_FULL }}"
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
