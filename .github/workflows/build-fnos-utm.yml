name: Patch fNOS for UTM
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # èµ‹äºˆ Release å†™å…¥æƒé™

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xz-utils grep sed tar
          echo "âœ… åŸºç¡€ä¾èµ–åº“å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"

          echo "ğŸ” æ­£åœ¨æœç´¢åŒ…å« 'rockchip' çš„æœ€æ–°é™„ä»¶..."

          # è·å–æŒ‡å®šreleaseä¸­åŒ…å«rockchipä¸”ä»¥.img.xzç»“å°¾çš„æœ€æ–°é™„ä»¶æ–‡ä»¶å
          # è¯¥å‘½ä»¤é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®ç°ï¼š
          # 1. ä½¿ç”¨gh cliæŸ¥è¯¢æŒ‡å®štagçš„releaseä¿¡æ¯ï¼Œæå–assetsæ•°ç»„ä¸­çš„æ–‡ä»¶å
          # 2. ç­›é€‰å‡ºåŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶çš„æ–‡ä»¶ï¼šä»¥.img.xzç»“å°¾ä¸”æ–‡ä»¶ååŒ…å«rockchip
          # 3. ä½¿ç”¨sedæå–æ–‡ä»¶åä¸­çš„ç‰ˆæœ¬å·å‰ç¼€ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°è¡Œé¦–ç”¨äºæ’åº
          # 4. æŒ‰æ•°å­—é¡ºåºæ’åºï¼Œç¡®ä¿ç‰ˆæœ¬å·é«˜çš„åœ¨æœ€å
          # 5. å–æœ€åä¸€ä¸ªï¼ˆå³ç‰ˆæœ¬å·æœ€å¤§çš„ï¼‰æ–‡ä»¶
          # 6. ç§»é™¤ä¹‹å‰æ·»åŠ çš„ç‰ˆæœ¬å·å‰ç¼€ï¼Œæ¢å¤åŸå§‹æ–‡ä»¶å
          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
           -q '.assets[] | select(.name | (endswith(".img.xz") and contains("rockchip"))) | .name' | \
           sed -E 's/.*_([0-9]+)\.img\.xz/\1 &/' | \
           sort -n | \
           tail -n 1 | \
           cut -d' ' -f2-)

          if [ -z "$LATEST_ASSET" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°åŒ…å« 'rockchip' ä¸”åç¼€ä¸º .img.xz çš„é™„ä»¶"
            exit 1
          fi

          echo "ğŸ¯ é”å®šæœ€æ–°é•œåƒ: $LATEST_ASSET"
          VERSION=$(echo "$LATEST_ASSET" | grep -oP '(?<=_)\d+(?=\.img\.xz)' || echo "unknown")

          if [ -n "$GITHUB_ENV" ]; then
            # å°†æå–çš„ç‰ˆæœ¬å·å’Œæºæ–‡ä»¶åå†™å…¥GitHubç¯å¢ƒå˜é‡
            # ä½¿åç»­æ­¥éª¤å¯ä»¥é€šè¿‡${{ env.VERSION }}å’Œ${{ env.SOURCE_FILE }}è®¿é—®è¿™äº›å˜é‡
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          fi

          # ä¸‹è½½æŒ‡å®šReleaseä¸­çš„å›ºä»¶é•œåƒæ–‡ä»¶
          # ä½¿ç”¨gh CLIå·¥å…·ä»ç›®æ ‡ä»“åº“çš„æŒ‡å®šæ ‡ç­¾ä¸‹è½½åŒ¹é…æ¨¡å¼çš„èµ„äº§æ–‡ä»¶
          # å‚æ•°è¯´æ˜:
          # - "$TAG": è¦ä¸‹è½½çš„Releaseæ ‡ç­¾åç§°
          # - -R "$REPO": æŒ‡å®šç›®æ ‡ä»“åº“åœ°å€
          # - -p "$LATEST_ASSET": æŒ‡å®šè¦ä¸‹è½½çš„èµ„äº§æ–‡ä»¶åæ¨¡å¼
          # - --clobber: è¦†ç›–å·²å­˜åœ¨çš„åŒåæ–‡ä»¶
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½: $LATEST_ASSET"
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber

      - name: Run decompress and patch script
        run: |
          chmod +x sh/decompress_and_patch.sh
          sh/decompress_and_patch.sh
        env:
          SOURCE_FILE: ${{ env.SOURCE_FILE }}
          VERSION: ${{ env.VERSION }}

      # æ·»åŠ ç¯å¢ƒå˜é‡éªŒè¯æ­¥éª¤
      - name: Validate Environment Variables
        run: |
          echo "ğŸ” éªŒè¯ç¯å¢ƒå˜é‡..."
          echo "VERSION: ${{ env.VERSION }}"
          echo "FINAL_PKG_NAME: ${{ env.FINAL_PKG_NAME }}"
          
          if [ -z "${{ env.VERSION }}" ]; then
            echo "âŒ é”™è¯¯ï¼šVERSION ç¯å¢ƒå˜é‡ä¸ºç©º"
            exit 1
          fi
          
          if [ -z "${{ env.FINAL_PKG_NAME }}" ]; then
            echo "âŒ é”™è¯¯ï¼šFINAL_PKG_NAME ç¯å¢ƒå˜é‡ä¸ºç©º"
            exit 1
          fi
          
          if [ ! -f "${{ env.FINAL_PKG_NAME }}" ]; then
            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ ${{ env.FINAL_PKG_NAME }} ä¸å­˜åœ¨"
            echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la
            exit 1
          fi
          
          echo "âœ… ç¯å¢ƒå˜é‡éªŒè¯é€šè¿‡"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          name: fnnas_utm_${{ env.VERSION }}
          body: |
            fnOS UTM è™šæ‹Ÿæœº ARM ç‰ˆ
          files: ${{ env.FINAL_PKG_NAME }}
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
