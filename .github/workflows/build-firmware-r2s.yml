name: Build FNNAS rk3328-nanopi-r2s

on:
  workflow_dispatch:  # 手动触发

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-utils parted gh

    - name: 获取最新 ophub/fnnas release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # 获取最新 release tag
        LATEST_TAG=$(gh release list --repo ophub/fnnas --limit 1 --json tagName -q '.[0].tagName')
        echo "最新 release tag: $LATEST_TAG"
        echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

    - name: 下载最新固件
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh release download "$LATEST_TAG" \
          --repo ophub/fnnas \
          --pattern '*renegade-rk3328*.img.gz'
        IMG_GZ=$(ls *renegade-rk3328*.img.gz)
        echo "下载完成: $IMG_GZ"
        echo "IMG_GZ=$IMG_GZ" >> $GITHUB_ENV
        echo "IMG=${IMG_GZ%.gz}" >> $GITHUB_ENV

    - name: 解压固件
      run: gzip -d "${{ env.IMG_GZ }}"

    - name: 修改 armbianEnv.txt
      run: |
        IMG="${{ env.IMG }}"
        LOOP=$(sudo losetup -fP "$IMG" --show)
        mkdir -p mnt
        sudo mount "${LOOP}p1" mnt
        sudo sed -i -E 's|^fdtfile=.*$|fdtfile=rockchip/rk3328-nanopi-r2s.dtb|' mnt/armbianEnv.txt
        sudo umount mnt
        sudo losetup -d "$LOOP"
        echo "armbianEnv.txt 修改完成"

    - name: 压缩并重命名固件
      run: |
        IMG="${{ env.IMG }}"
        gzip "$IMG"
        NEW_NAME=$(echo "$IMG.gz" | sed 's/renegade-rk3328/rk3328-nanopi-r2s/')
        mv "$IMG.gz" "$NEW_NAME"
        echo "最终固件: $NEW_NAME"
        echo "NEW_NAME=$NEW_NAME" >> $GITHUB_ENV

    - name: 检查 release 是否存在，如果不存在则创建
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        if gh release view "$LATEST_TAG" >/dev/null 2>&1; then
          echo "Release $LATEST_TAG 已存在，将覆盖上传文件。"
        else
          echo "Release $LATEST_TAG 不存在，创建新的 release。"
          gh release create "$LATEST_TAG" --title "$LATEST_TAG" --notes "自动构建固件" || true
        fi

    - name: 上传固件（覆盖现有 release 文件）
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.LATEST_TAG }}   # release tag 与 ophub/fnnas 同步
        name: ${{ env.LATEST_TAG }}       # release title 与 ophub/fnnas 同步
        files: ${{ env.NEW_NAME }}        # 上传修改后的固件文件
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

