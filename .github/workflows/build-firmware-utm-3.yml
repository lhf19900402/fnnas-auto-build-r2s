name: Patch fNOS Image for UTM (Standard Kernel)
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed tar kmod zstd curl
          echo "âœ… åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"
          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
            -q '.assets[] | select(.name | endswith(".img.xz")) | .name' | \
            sed -E 's/.*_([0-9]+)\.img\.xz/\1 &/' | \
            sort -n | tail -n 1 | cut -d' ' -f2-)
          
          echo "VERSION=$(echo "$LATEST_ASSET" | grep -oP '(?<=_)\d+(?=\.img\.xz)')" >> $GITHUB_ENV
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber

      - name: Decompress and Patch Image
        run: |
          echo "ğŸ“¦ æ­£åœ¨è§£å‹æ–°é•œåƒ..."
          unxz -v -c "${{ env.SOURCE_FILE }}" > source.img
          
          sudo losetup -D
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          
          # 1. ä¸¥æ ¼ä¿ç•™ä½ éªŒè¯è¿‡çš„æå–æŒ‚è½½é€»è¾‘
          echo "ğŸ’¾ æ­£åœ¨æå–å¹¶æŒ‚è½½ Rootfs..."
          mkdir -p mnt_new
          sudo dd if="${LOOP_DEV}p2" of=rootfs.img bs=1M status=none
          sudo mount rootfs.img mnt_new

          # 2. ã€ç‰ˆæœ¬å“¨å…µã€‘æ£€æµ‹å®˜æ–¹æœ€æ–°å†…æ ¸
          echo "ğŸ” æ­£åœ¨æ£€æŸ¥ Debian å®˜æ–¹ä»“åº“å†…æ ¸çŠ¶æ€..."
          INDEX_URL="http://ftp.debian.org/debian/dists/bookworm/main/binary-arm64/Packages.gz"
          LATEST_KVER_FULL=$(curl -s "$INDEX_URL" | zgrep "Package: linux-image-6.1.0-" | awk '{print $2}' | grep -vE "rt|dbg|unsigned|cloud" | sort -V | tail -n 1)
          LATEST_KVER=$(echo $LATEST_KVER_FULL | sed 's/linux-image-//;s/-arm64//')
          echo "OFFICIAL_KVER=$LATEST_KVER" >> $GITHUB_ENV

          # 3. è¯†åˆ«ä½ ä»“åº“é‡Œå½“å‰ä½¿ç”¨çš„å¼•å¯¼æ–‡ä»¶ç‰ˆæœ¬
          # å‡è®¾ä½ çš„æ–‡ä»¶åæ ¼å¼ä¸º: vmlinuz-6.1.0-42-arm64
          LOCAL_KVER=$(ls boot_files/vmlinuz-* | grep -oP '6\.1\.0-\d+' | head -n 1)
          echo "LOCAL_KVER=$LOCAL_KVER" >> $GITHUB_ENV
          echo "ğŸ“¢ ä»“åº“æœ¬åœ°ç‰ˆæœ¬: $LOCAL_KVER | å®˜æ–¹æœ€æ–°ç‰ˆæœ¬: $LATEST_KVER"

          # 4. é©±åŠ¨æ³¨å…¥é€»è¾‘ï¼šä¸‹è½½ä¸æœ¬åœ°å¼•å¯¼æ–‡ä»¶ç‰ˆæœ¬ä¸€è‡´çš„ .deb åŒ…
          # è¿™æ ·å¯ä»¥ç¡®ä¿ rootfs é‡Œçš„é©±åŠ¨æ¨¡å— (/lib/modules) ä¸ä½ çš„ vmlinuz/initrd å®Œç¾åŒ¹é…
          RELATIVE_PATH=$(curl -s "$INDEX_URL" | zgrep -A 20 "Package: linux-image-$LOCAL_KVER-arm64$" | grep "Filename: " | awk '{print $2}' | head -n 1)
          
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ç‰ˆæœ¬ $LOCAL_KVER çš„é©±åŠ¨æ¨¡å—..."
          curl -fL -o kernel.deb "http://ftp.debian.org/debian/$RELATIVE_PATH"
          
          # æ¸…ç†æ—§æ¨¡å—å¹¶æ³¨å…¥åŒ¹é…æ¨¡å—
          sudo rm -rf mnt_new/lib/modules/*
          sudo dpkg-deb -x kernel.deb mnt_new/

          # 5. æå–æœ¬åœ°å¼•å¯¼æ–‡ä»¶å‡†å¤‡æ‰“åŒ…
          cp boot_files/vmlinuz-$LOCAL_KVER-arm64 ./vmlinuz-standard
          cp boot_files/initrd.img-$LOCAL_KVER-arm64 ./initrd-standard

          # 6. åº”ç”¨è™šæ‹Ÿæœºé€‚é…ä¿®æ­£ (ä¿ç•™ä½ çš„åŸé€»è¾‘)
          echo "ğŸ› ï¸ åº”ç”¨è™šæ‹Ÿæœºé€‚é…ä¿®æ­£..."
          sudo sed -i 's/^.*\/boot/#&/' mnt_new/etc/fstab
          sudo sed -i 's/^\/dev\/mmcblk0p2/\/dev\/vda/' mnt_new/etc/fstab
          
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_miniscreen.service
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_wayland.service

          # 7. å½»åº•æ¸…ç†å¸è½½
          sudo umount mnt_new
          sudo losetup -d $LOOP_DEV
          rm source.img kernel.deb
          echo "âœ… è¡¥ä¸å¤„ç†å®Œæˆ"

      - name: Final Packaging
        run: |
          PKG_DIR="fn_utm_${{ env.VERSION }}"
          mkdir -p "$PKG_DIR"
          mv rootfs.img vmlinuz-standard initrd-standard "$PKG_DIR/"
          
          # åœ¨ README ä¸­è®°å½•ç‰ˆæœ¬å¯¹æ¯”
          cat << EOF > "$PKG_DIR/README.md"
          # fNOS UTM ARM64 (Handcrafted Kernel Mode)
          
          - é£ç‰›é•œåƒç‰ˆæœ¬: ${{ env.VERSION }}
          - å¼•å¯¼å†…æ ¸ç‰ˆæœ¬: ${{ env.LOCAL_KVER }}
          - å®˜æ–¹ä»“åº“æœ€æ–°: ${{ env.OFFICIAL_KVER }}
          
          ${{ env.LOCAL_KVER != env.OFFICIAL_KVER && 'âš ï¸ æ³¨æ„ï¼šDebian å®˜æ–¹å·²æ›´æ–°ï¼Œå»ºè®®åœ¨æœ¬åœ° ARM è™šæ‹Ÿæœºç”Ÿæˆæ–°å†…æ ¸åæ›¿æ¢ boot_files ç›®å½•æ–‡ä»¶ã€‚' || 'âœ… å½“å‰å¼•å¯¼æ–‡ä»¶å·²æ˜¯å®˜æ–¹æœ€æ–°ç‰ˆæœ¬ã€‚' }}
          
          ## UTM é…ç½®æŒ‡å—
          1. ç£ç›˜: rootfs.img (Interface: VirtIO)
          2. å†…æ ¸: vmlinuz-standard
          3. Initrd: initrd-standard
          4. å‚æ•°: "root=/dev/vda rw console=tty0 console=ttyAMA0 rootwait"
          EOF

          tar -cvf - "$PKG_DIR" | xz -z -T0 -v > "${PKG_DIR}.tar.xz"
          echo "FINAL_PKG_NAME=${PKG_DIR}.tar.xz" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          name: fnnas_utm_${{ env.VERSION }}
          body: |
            fnOS UTM è¡¥ä¸ç‰ˆ
            - é£ç‰›ç‰ˆæœ¬: ${{ env.VERSION }}
            - å†…æ ¸ç‰ˆæœ¬: ${{ env.LOCAL_KVER }}
            - å®˜æ–¹çŠ¶æ€: ${{ env.OFFICIAL_KVER }}
          files: ${{ env.FINAL_PKG_NAME }}
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
