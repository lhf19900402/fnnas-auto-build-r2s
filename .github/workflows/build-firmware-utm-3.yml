name: Patch fNOS Image for UTM
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest  # æ— éœ€æ’é˜Ÿï¼Œç§’é€Ÿå¯åŠ¨
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed tar kmod zstd curl file
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"
          # è·å–æœ€æ–°çš„ .img.xz èµ„æºå
          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
            -q '.assets[] | select(.name | endswith(".img.xz")) | .name' | \
            sort -V | tail -n 1)
          
          VERSION=$(echo "$LATEST_ASSET" | grep -oP '\d+(?=\.img\.xz)')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          
          echo "ğŸ“¥ æ­£åœ¨ä» $REPO ä¸‹è½½åŸºç¡€é•œåƒ..."
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber

      - name: Decompress and Inject Kernel (Extreme Speed)
        run: |
          echo "ğŸ“¦ æ­£åœ¨å¹¶è¡Œè§£å‹é•œåƒ..."
          unxz -v -c "${{ env.SOURCE_FILE }}" > source.img
          
          # æŒ‚è½½é•œåƒ
          sudo losetup -D
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          
          echo "ğŸ’¾ æ­£åœ¨æå–å¹¶æŒ‚è½½ Rootfs..."
          mkdir -p mnt_new
          sudo dd if="${LOOP_DEV}p2" of=rootfs.img bs=1M status=none
          sudo mount rootfs.img mnt_new

          # --- åŠ¨æ€ç²¾å‡†æŠ“å–å†…æ ¸ ---
          echo "ğŸŒ æ­£åœ¨ä» Debian å®˜æ–¹æœç´¢æœ€æ–°æ ‡å‡†ç‰ˆ ARM64 å†…æ ¸..."
          INDEX_URL="http://ftp.debian.org/debian/dists/bookworm/main/binary-arm64/Packages.gz"
          
          # ä½¿ç”¨æœ¬åœ°éªŒè¯é€šè¿‡çš„æ­£åˆ™é€»è¾‘ï¼šç¡®ä¿ä»¥ arm64 ç»“å°¾ï¼Œæ’é™¤ -dbg
          RELATIVE_PATH=$(curl -s "$INDEX_URL" | zgrep -A 20 "Package: linux-image-6.1.0-.*-arm64$" | grep "Filename:" | head -n 1 | awk '{print $2}')
          
          if [ -z "$RELATIVE_PATH" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯ï¼šæ— æ³•åœ¨ Debian ä»“åº“ä¸­å®šä½å†…æ ¸åŒ…è·¯å¾„ï¼"
            exit 1
          fi

          KERNEL_URL="http://ftp.debian.org/debian/$RELATIVE_PATH"
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½å†…æ ¸åŒ…: $KERNEL_URL"
          
          # å¢åŠ  -f å‚æ•°é˜²æ­¢ 404 é™é»˜å¤±è´¥
          curl -fL -o kernel.deb "$KERNEL_URL"
          
          # æ ¡éªŒæ–‡ä»¶ç±»å‹
          if ! file kernel.deb | grep -q "Debian binary package"; then
            echo "âŒ æ ¡éªŒå¤±è´¥ï¼šä¸‹è½½çš„æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ .deb åŒ…"
            exit 1
          fi
          
          echo "ğŸ› ï¸ æ­£åœ¨æ‰§è¡Œç¦»çº¿æ³¨å…¥ (è·³è¿‡ QEMU æ¨¡æ‹Ÿ)..."
          mkdir -p kextract
          dpkg-deb -x kernel.deb kextract/
          
          # åŒæ­¥é©±åŠ¨æ¨¡å—å¹¶æå–å¯åŠ¨å¿…å¤‡æ–‡ä»¶
          sudo cp -r kextract/lib/modules/* mnt_new/lib/modules/
          cp kextract/boot/vmlinuz-* ./vmlinuz-standard
          cp kextract/boot/initrd.img-* ./initrd-standard
          
          # ç§»é™¤ä¸åŒ¹é…çš„æ—§é©±åŠ¨ï¼ŒèŠ‚çœç©ºé—´
          sudo rm -rf mnt_new/lib/modules/6.12.41-trim
          # -----------------------

          echo "ğŸ› ï¸ é€‚é… UTM è™šæ‹Ÿæœºä¿®æ­£..."
          # ä¿®æ­£ fstab
          sudo sed -i 's/^.*\/boot/#&/' mnt_new/etc/fstab
          sudo sed -i 's/^UUID=[^ ]*/\/dev\/vda/' mnt_new/etc/fstab
          sudo sed -i 's/^\/dev\/mmcblk0p2/\/dev\/vda/' mnt_new/etc/fstab
          
          # ç¦ç”¨é£ç‰›åœ¨æŸäº›ç¡¬ä»¶ä¸Šçš„å†²çªæœåŠ¡
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_miniscreen.service
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_wayland.service

          echo "ğŸ§¹ å¸è½½å¹¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          sudo umount mnt_new
          sudo losetup -d $LOOP_DEV
          rm source.img
          rm -rf kextract *.deb
          echo "âœ… è¡¥ä¸å¤„ç†å®Œæˆ"

      - name: Final Packaging
        run: |
          PKG_DIR="fn_utm_${{ env.VERSION }}"
          mkdir -p "$PKG_DIR"
          mv rootfs.img vmlinuz-standard initrd-standard "$PKG_DIR/"
          
          cat << EOF > "$PKG_DIR/README.md"
          # fNOS UTM ARM64 é€‚é…åŒ…
          
          ## UTM è®¾ç½®æŒ‡å—:
          1. **ç³»ç»Ÿ (System)**: æ¶æ„é€‰ ARM64ã€‚
          2. **ç£ç›˜ (Drives)**: å¯¼å…¥ \`rootfs.img\`ï¼Œæ¥å£åŠ¡å¿…é€‰æ‹© **VirtIO**ã€‚
          3. **å¼•å¯¼ (Boot)**: å¼€å¯ "Use External Kernel"ï¼Œé€‰æ‹©æä¾›çš„ \`vmlinuz-standard\` å’Œ \`initrd-standard\`ã€‚
          4. **å¯åŠ¨å‚æ•° (Arguments)**: \`root=/dev/vda rw console=tty0 console=ttyAMA0 rootwait\`
          EOF

          tar -cvf - "$PKG_DIR" | xz -z -T0 -v > "${PKG_DIR}.tar.xz"
          echo "FINAL_PKG_NAME=${PKG_DIR}.tar.xz" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          name: fnnas_utm_${{ env.VERSION }}
          body: |
            é£ç‰› OS (fNOS) UTM ä¸“ç”¨è¡¥ä¸é•œåƒ
            - æ„å»ºæ—¶é—´: ${{ github.event.repository.updated_at }}
            - å†…æ ¸ç‰ˆæœ¬: éš Debian 12 è‡ªåŠ¨æ›´æ–° (ç›®å‰ä¸º 6.1.0-39)
            - é€‚é…ç¯å¢ƒ: UTM (Apple Silicon Mac)
          files: ${{ env.FINAL_PKG_NAME }}
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
