name: Patch fNOS Image for UTM
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # èµ‹äºˆ Release å†™å…¥æƒé™

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed tar
          echo "âœ… åŸºç¡€ä¾èµ–åº“å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="ophub/fnnas"
          TAG="fnnas_base_image"

          echo "ğŸ” æ­£åœ¨æœç´¢åŒ…å« 'rockchip' çš„æœ€æ–°é™„ä»¶..."

          LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
           -q '.assets[] | select(.name | (endswith(".img.xz") and contains("rockchip"))) | .name' | \
           sed -E 's/.*_([0-9]+)\.img\.xz/\1 &/' | \
           sort -n | \
           tail -n 1 | \
           cut -d' ' -f2-)

          if [ -z "$LATEST_ASSET" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°åŒ…å« 'rockchip' ä¸”åç¼€ä¸º .img.xz çš„é™„ä»¶"
            exit 1
          fi

          echo "ğŸ¯ é”å®šæœ€æ–°é•œåƒ: $LATEST_ASSET"
          VERSION=$(echo "$LATEST_ASSET" | grep -oP '(?<=_)\d+(?=\.img\.xz)' || echo "unknown")

          if [ -n "$GITHUB_ENV" ]; then
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
          fi

          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½: $LATEST_ASSET"
          gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber

      - name: Run decompress and patch script
        run: |
          chmod +x sh/decompress_and_patch.sh
          sh/decompress_and_patch.sh
        env:
          SOURCE_FILE: ${{ env.SOURCE_FILE }}
          VERSION: ${{ env.VERSION }}

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          name: fnnas_utm_${{ github.env.VERSION }}
          body: |
            fnOS UTM è™šæ‹Ÿæœº ARM ç‰ˆ
          files: ${{ github.env.FINAL_PKG_NAME }}
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
