name: Patch fNOS Image for UTM
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed

      - name: Get Latest Release Info and Download
        id: get_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” æ­£åœ¨æœç´¢ ophub/fnnas ä»“åº“ä¸­ fnnas_base_image çš„æœ€æ–°é™„ä»¶..."
          
          # è·å– release è¯¦æƒ…ï¼Œå¹¶è¿‡æ»¤å‡ºæœ€æ–°çš„ .img.xz æ–‡ä»¶å
          # å‡è®¾æ–‡ä»¶åæ ¼å¼å¦‚: fnnas-official-arm64-image_allwinner_317.img.xz
          LATEST_ASSET=$(gh release view fnnas_base_image -R ophub/fnnas --json assets \
            -q '.assets[] | select(.name | endswith(".img.xz")) | .name' | sort -V | tail -n 1)
          
          if [ -z "$LATEST_ASSET" ]; then
            echo "âŒ é”™è¯¯ï¼šåœ¨ ophub/fnnas çš„ fnnas_base_image ä¸­æ²¡æ‰¾åˆ° .img.xz æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… å‘ç°æœ€æ–°é™„ä»¶: $LATEST_ASSET"

          # æå–ç‰ˆæœ¬å· (æˆªå–æœ€åä¸€ä¸ªä¸‹åˆ’çº¿åˆ°ç¬¬ä¸€ä¸ªç‚¹ä¹‹é—´çš„æ•°å­—)
          # ä¾‹å¦‚ä» ...allwinner_317.img.xz æå–å‡º 317
          VERSION=$(echo "$LATEST_ASSET" | grep -oP '(?<=_)\d+(?=\.img\.xz)')
          if [ -z "$VERSION" ]; then
             echo "âš ï¸ æ— æ³•ä»æ–‡ä»¶åæå–ç‰ˆæœ¬å·ï¼Œä½¿ç”¨ timestamp ä»£æ›¿"
             VERSION=$(date +%s)
          fi
          echo "âœ… æå–ç‰ˆæœ¬å·: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # ä¸‹è½½æ–‡ä»¶
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½é™„ä»¶..."
          gh release download fnnas_base_image -R ophub/fnnas -p "$LATEST_ASSET" --clobber
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV

      - name: Decompress and Patch Image
        run: |
          echo "ğŸ“¦ æ­£åœ¨è§£å‹é•œåƒ: ${{ env.SOURCE_FILE }} ..."
          unxz -c "${{ env.SOURCE_FILE }}" > source.img || { echo "âŒ è§£å‹å¤±è´¥"; exit 1; }

          echo "ğŸ› ï¸ æ­£åœ¨è®¾ç½® Loop è®¾å¤‡..."
          sudo losetup -D
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          if [ -z "$LOOP_DEV" ]; then echo "âŒ å…³è” Loop è®¾å¤‡å¤±è´¥"; exit 1; fi
          echo "âœ… å…³è”åˆ°: $LOOP_DEV"

          mkdir -p mnt_p1 mnt_p2

          # 1. æå–å†…æ ¸ (p1)
          echo "ğŸ“‚ æ­£åœ¨æŒ‚è½½åˆ†åŒº 1 å¹¶æå–å†…æ ¸..."
          sudo mount "${LOOP_DEV}p1" mnt_p1 || { echo "âŒ æŒ‚è½½ p1 å¤±è´¥"; exit 1; }
          
          KERNEL_PATH=$(sudo find mnt_p1 -name "vmlinuz-*" ! -name "*.old" | sort -V | tail -n 1)
          INITRD_PATH=$(sudo find mnt_p1 -name "initrd.img-*" ! -name "*.old" | sort -V | tail -n 1)
          
          if [ -n "$KERNEL_PATH" ]; then
            RAW_KERNEL=$(basename "$KERNEL_PATH")
            RAW_INITRD=$(basename "$INITRD_PATH")
            cp "$KERNEL_PATH" ./"$RAW_KERNEL"
            cp "$INITRD_PATH" ./"$RAW_INITRD"
            echo "RAW_KERNEL=$RAW_KERNEL" >> $GITHUB_ENV
            echo "RAW_INITRD=$RAW_INITRD" >> $GITHUB_ENV
            echo "âœ… æˆåŠŸæå–å†…æ ¸: $RAW_KERNEL"
          else
            echo "âŒ é”™è¯¯ï¼šåœ¨ p1 æœªæ‰¾åˆ°å†…æ ¸æ–‡ä»¶"; exit 1
          fi
          sudo umount mnt_p1

          # 2. ä¿®æ”¹ç³»ç»Ÿé…ç½® (p2)
          echo "ğŸ› ï¸ æ­£åœ¨æŒ‚è½½åˆ†åŒº 2 ä¿®æ­£ç³»ç»Ÿé…ç½®..."
          sudo mount "${LOOP_DEV}p2" mnt_p2 || { echo "âŒ æŒ‚è½½ p2 å¤±è´¥"; exit 1; }
          
          # ä¿®æ­£ fstab
          sudo sed -i 's/^.*\/boot/#&/' mnt_p2/etc/fstab
          sudo sed -i 's/^\/dev\/mmcblk0p2/\/dev\/vdb2/' mnt_p2/etc/fstab
          
          # ç¦ç”¨æœåŠ¡
          sudo rm -f mnt_p2/etc/systemd/system/multi-user.target.wants/trim_miniscreen.service
          sudo rm -f mnt_p2/etc/systemd/system/multi-user.target.wants/trim_wayland.service
          
          echo "âœ… fstab å’ŒæœåŠ¡ä¿®æ­£å®Œæˆ"
          sudo umount mnt_p2
          sudo losetup -D

      - name: Compress Final Image
        run: |
          # æ³¨æ„ï¼šåœ¨ run å—é‡Œï¼Œç›´æ¥ç”¨ $VERSION å¼•ç”¨ä¹‹å‰å­˜å…¥ GITHUB_ENV çš„å˜é‡
          FINAL_NAME="fn_utm_${VERSION}.img.xz"
          echo "ğŸ—œï¸ æ­£åœ¨é‡æ–°æ‰“åŒ…ä¸º $FINAL_NAME ..."
          xz -z -T0 -v -c source.img > "$FINAL_NAME"
          # å¿…é¡»å­˜å…¥ GITHUB_ENVï¼Œä¸‹ä¸ª Step æ‰èƒ½çœ‹åˆ°
          echo "FINAL_IMG_NAME=$FINAL_NAME" >> $GITHUB_ENV
          echo "âœ… æ‰“åŒ…å®Œæˆ"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fnos-utm-v${{ env.VERSION }}
          path: |
            ${{ env.FINAL_IMG_NAME }}
            ${{ env.RAW_KERNEL }}
            ${{ env.RAW_INITRD }}
