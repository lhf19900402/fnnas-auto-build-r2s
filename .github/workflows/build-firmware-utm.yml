name: Patch fNOS Image for UTM
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # èµ‹äºˆ Release å†™å…¥æƒé™

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fdisk xz-utils grep sed tar
          echo "âœ… åŸºç¡€ä¾èµ–åº“å®‰è£…å®Œæˆ"

      - name: Get Latest Release Info and Download
        id: get_info
        env: 
         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
         REPO="ophub/fnnas"
         TAG="fnnas_base_image"
        
         echo "ğŸ” æ­£åœ¨æœç´¢åŒ…å« 'rockchip' çš„æœ€æ–°é™„ä»¶..."
        
         # åœ¨ select ä¸­å¢åŠ äº†å¯¹ "rockchip" å­—ç¬¦ä¸²çš„åˆ¤æ–­
         LATEST_ASSET=$(gh release view "$TAG" -R "$REPO" --json assets \
          -q '.assets[] | select(.name | (endswith(".img.xz") and contains("rockchip"))) | .name' | \
          sed -E 's/.*_([0-9]+)\.img\.xz/\1 &/' | \
          sort -n | \
          tail -n 1 | \
          cut -d' ' -f2-)
        
         if [ -z "$LATEST_ASSET" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°åŒ…å« 'rockchip' ä¸”åç¼€ä¸º .img.xz çš„é™„ä»¶"
          exit 1
         fi
        
         echo "ğŸ¯ é”å®šæœ€æ–°é•œåƒ: $LATEST_ASSET"
         VERSION=$(echo "$LATEST_ASSET" | grep -oP '(?<=_)\d+(?=\.img\.xz)' || echo "unknown")
        
         # å†™å…¥ç¯å¢ƒå˜é‡ (å…¼å®¹ GitHub Actions ç¯å¢ƒ)
         if [ -n "$GITHUB_ENV" ]; then
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SOURCE_FILE=$LATEST_ASSET" >> $GITHUB_ENV
         fi
        
         echo "ğŸ“¥ å¼€å§‹ä¸‹è½½: $LATEST_ASSET"
         gh release download "$TAG" -R "$REPO" -p "$LATEST_ASSET" --clobber
  
      - name: Decompress and Patch Image
        run: |
          echo "ğŸ“¦ æ­£åœ¨è§£å‹é•œåƒ..."
          unxz -v -c "${{ env.SOURCE_FILE }}" > source.img
          rm "${{ env.SOURCE_FILE }}"

          # å¯åŠ¨ Loop è®¾å¤‡å¹¶æ‰«æåˆ†åŒº
          sudo losetup -D
          LOOP_DEV=$(sudo losetup -Pf --show source.img)
          mkdir -p mnt_p1 mnt_new

          # 1. æå–å†…æ ¸ç»„ä»¶ (ä¿æŒåŠ¨æ€å‘½åé€»è¾‘)
          echo "ğŸ“‚ æ­£åœ¨æ¢æµ‹åŸå§‹å†…æ ¸æ–‡ä»¶..."
          sudo mount -o ro "${LOOP_DEV}p1" mnt_p1
          KERNEL_PATH=$(sudo find mnt_p1 -name "vmlinuz-*" ! -name "*.old" | sort -V | tail -n 1)
          INITRD_PATH=$(sudo find mnt_p1 -name "initrd.img-*" ! -name "*.old" | sort -V | tail -n 1)
          
          RAW_KERNEL=$(basename "$KERNEL_PATH")
          RAW_INITRD=$(basename "$INITRD_PATH")
          
          cp "$KERNEL_PATH" ./"$RAW_KERNEL"
          cp "$INITRD_PATH" ./"$RAW_INITRD"
          
          echo "RAW_KERNEL=$RAW_KERNEL" >> $GITHUB_ENV
          echo "RAW_INITRD=$RAW_INITRD" >> $GITHUB_ENV
          sudo umount mnt_p1

          # 2. æå– P2 åˆ†åŒº (è„šæœ¬ 1 æ ¸å¿ƒé€»è¾‘ï¼šBlock-to-Block æ‹·è´)
          echo "ğŸ’¾ æ­£åœ¨å…‹éš† P2 åˆ†åŒºåˆ° rootfs.img..."
          sudo dd if="${LOOP_DEV}p2" of=rootfs.img bs=1M status=none
          
          # å¸è½½åŸ loop è®¾å¤‡ï¼Œé‡Šæ”¾èµ„æº
          sudo losetup -d $LOOP_DEV

          # 3. æŒ‚è½½æ–°ç”Ÿæˆçš„ rootfs.img è¿›è¡Œé€‚é…ä¿®æ­£ (è„šæœ¬ 1 æ ¸å¿ƒé€»è¾‘)
          echo "ğŸ› ï¸ æ­£åœ¨åº”ç”¨è™šæ‹Ÿæœºé€‚é…ä¿®æ­£..."
          sudo mount rootfs.img mnt_new

          # echo ">>> [ä¿®æ”¹å‰] fstab å†…å®¹:"
          # cat mnt_new/etc/fstab
          # # ä¿®æ­£ fstabï¼šç¦ç”¨ boot åˆ†åŒºæŒ‚è½½ï¼Œå¹¶å°†æ ¹ç›®å½•è®¾ä¸º vda
          # sudo sed -i 's/^.*\/boot/#&/' mnt_new/etc/fstab
          # sudo sed -i 's/^\/dev\/mmcblk0p2/\/dev\/vda/' mnt_new/etc/fstab
          # echo ">>> [ä¿®æ”¹å] fstab å†…å®¹:"
          # cat mnt_new/etc/fstab
          
          # ç§»é™¤ç‰©ç†ç¡¬ä»¶å†²çªæœåŠ¡
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_miniscreen.service
          sudo rm -f mnt_new/etc/systemd/system/multi-user.target.wants/trim_wayland.service

          # å¼ºåˆ¶åˆ·æ–°ç¼“å­˜å¹¶å¸è½½
          sync
          sudo umount mnt_new
          
          rm source.img
          echo "âœ… ä¿®å¤å®Œæˆï¼Œæ ¹åˆ†åŒºå·²é€‚é…ä¸º /dev/vda"

      - name: Create README for UTM
        run: |
          cat << EOF > README.md
          # fNOS UTM è™šæ‹Ÿæœºä½¿ç”¨è¯´æ˜ (v${{ env.VERSION }})

          ## ğŸš€ UTM é…ç½®å…³é”®ç‚¹
          1. **é©±åŠ¨å™¨**: å¯¼å…¥ \`rootfs.img\`ï¼Œæ¥å£é€‰æ‹© **VirtIO**ã€‚
          2. **é«˜çº§**:
             - å‹¾é€‰ **"ä½¿ç”¨æœ¬åœ°å†…æ ¸/initrd"**ã€‚
             - **External Kernel**: é€‰æ‹© \`${{ env.RAW_KERNEL }}\`ã€‚
             - **Initrd**: é€‰æ‹© \`${{ env.RAW_INITRD }}\`ã€‚
          3. **å¯åŠ¨å‚æ•° (Arguments)**:
             è¯·åœ¨ QEMU å‚æ•°æœ€åä¸€æ å¡«å…¥ï¼ˆåŒ…å«å¼•å·ï¼‰ï¼š
             \`\`\`text
             -append
             "root=/dev/vdb rw console=tty0 console=ttyAMA0 earlycon"
             \`\`\`
          EOF

      - name: Final Packaging (Tar + XZ)
        run: |
          PKG_DIR="fn_utm_${{ env.VERSION }}"
          mkdir -p "$PKG_DIR"
          
          mv rootfs.img "$PKG_DIR/"
          mv "${{ env.RAW_KERNEL }}" "$PKG_DIR/"
          mv "${{ env.RAW_INITRD }}" "$PKG_DIR/"
          mv README.md "$PKG_DIR/"
          
          echo "ğŸ—œï¸ æ­£åœ¨æ‰“åŒ…å‹ç¼©..."
          tar -cvf - "$PKG_DIR" | xz -z -T0 -v > "${PKG_DIR}.tar.xz"
          
          echo "FINAL_PKG_NAME=${PKG_DIR}.tar.xz" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fnnas_utm
          name: fnnas_utm_${{ env.VERSION }}
          body: |
            fnOS UTM è™šæ‹Ÿæœº ARM ç‰ˆ 
          files: ${{ env.FINAL_PKG_NAME }}
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
