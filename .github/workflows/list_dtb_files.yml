name: List FNNAS dtb Files

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  list-dtb:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-utils gh gzip zip

    - name: 获取最新 ophub/fnnas release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        LATEST_TAG=$(gh release list --repo ophub/fnnas --limit 1 --json tagName -q '.[0].tagName')
        echo "最新 release tag: $LATEST_TAG"
        echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

    - name: 下载最新固件
      env:
        GH_TOKEN: ${{ github.token }}
        LATEST_TAG: ${{ env.LATEST_TAG }}
      run: |
        gh release download "$LATEST_TAG" \
          --repo ophub/fnnas \
          --pattern '*renegade-rk3328*.img.gz'
        IMG_GZ=$(ls *renegade-rk3328*.img.gz)
        echo "下载完成: $IMG_GZ"
        echo "IMG_GZ=$IMG_GZ" >> $GITHUB_ENV

    - name: 列出 dtb 文件并打包 boot 分区
      env:
        IMG_GZ: ${{ env.IMG_GZ }}
      run: |
        IMG="${IMG_GZ%.gz}"
        gzip -dk "$IMG_GZ"

        sudo mkdir -p /mnt/boot
        LOOP=$(sudo losetup -fP --show "$IMG")
        sudo partprobe "$LOOP"

        # 检查 p1 分区是否存在
        if [ ! -b "${LOOP}p1" ]; then
          echo "错误: 分区 p1 不存在！"
          exit 1
        fi

        sudo mount "${LOOP}p1" /mnt/boot

        # 列出 dtb 文件
        echo "===== /dtb/rockchip 下的文件 ====="
        find /mnt/boot/dtb/rockchip -type f -exec basename {} \; | sort

        # 打包 boot 分区
        ARTIFACT_NAME="boot_partition.zip"
        sudo zip -r "$ARTIFACT_NAME" /mnt/boot
        sudo chown $USER:$USER "$ARTIFACT_NAME"
        echo "ARTIFACT=$ARTIFACT_NAME" >> $GITHUB_ENV

        # 卸载和释放 loop
        sudo umount /mnt/boot
        sudo losetup -d "$LOOP"

    - name: 上传 boot 分区 artifact
      uses: actions/upload-artifact@v4
      with:
        name: boot_partition
        path: ${{ env.ARTIFACT }}
