name: List FNNAS dtb Files (Optimized)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  list-dtb:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-utils gh gzip zip p7zip-full

    - name: 获取最新 ophub/fnnas release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        LATEST_TAG=$(gh release list --repo ophub/fnnas --limit 1 --json tagName -q '.[0].tagName')
        echo "最新 release tag: $LATEST_TAG"
        echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

    - name: 下载最新固件
      env:
        GH_TOKEN: ${{ github.token }}
        LATEST_TAG: ${{ env.LATEST_TAG }}
      run: |
        gh release download "$LATEST_TAG" \
          --repo ophub/fnnas \
          --pattern '*renegade-rk3328*.img.gz'
        IMG_GZ=$(ls *renegade-rk3328*.img.gz)
        echo "下载完成: $IMG_GZ"
        echo "IMG_GZ=$IMG_GZ" >> $GITHUB_ENV

    - name: 解压 dtb 文件并列出 /dtb/rockchip
      env:
        IMG_GZ: ${{ env.IMG_GZ }}
      run: |
        # 创建临时目录
        TMPDIR=$(mktemp -d)
        IMG="${TMPDIR}/firmware.img"

        # 解压 img.gz
        gzip -dc "$IMG_GZ" > "$IMG"

        # 创建临时目录提取 boot 分区内容
        EXTRACT_DIR="${TMPDIR}/boot"
        mkdir -p "$EXTRACT_DIR"

        # 使用 7z 直接提取 boot/dtb/rockchip
        7z x "$IMG" "boot/dtb/rockchip/*" -o"$EXTRACT_DIR" > /dev/null

        echo "===== /dtb/rockchip 下的文件 ====="
        find "$EXTRACT_DIR/dtb/rockchip" -type f -exec basename {} \; | sort

        # 将 boot 分区打包为 artifact
        ARTIFACT_NAME="boot_partition.zip"
        zip -r "$ARTIFACT_NAME" "$EXTRACT_DIR"

        echo "ARTIFACT=$ARTIFACT_NAME" >> $GITHUB_ENV

    - name: 上传 boot 分区 artifact
      uses: actions/upload-artifact@v4
      with:
        name: boot_partition
        path: ${{ env.ARTIFACT }}
